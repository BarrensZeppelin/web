{% extends 'base.html' %}

{% block content %}

{% load items_extras %}
{% load staticfiles %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.7/css/select2.css" integrity="sha256-cxYyFTq8AlfZjXRMeAy8KPHpmNVSpUNhnxQwNfUT0Lo=" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.7/js/select2.min.js" integrity="sha256-GHC3xFbrevQ0aRcWg5JElUOncXYXxTtMOuA74cWAPTw=" crossorigin="anonymous"></script>

<style>
#scanner-container {
	position: fixed;
    top: 50px;
    bottom: 50px;
    left: 50px;
    right: 50px;
    z-index: 100;
    background-color: white;
	border: solid;
	font-size: 4rem;
	padding: 50px;
	visibility: hidden;
}
#scanner-container.not-hidden {
	visibility: visible;
}
#scanner-container div {
	height: 4rem;
	margin-top: 2rem;
}
#scanner-input {
	margin-top: 4rem;
	margin: auto;
	display: block;
	font-size: 5rem;
}
#scanner-item-select {
	width: 90%;
}
</style>

<button id="scanner-button" type="submit" class="btn btn-primary btn-block">Åben scanner</button>
<div id="scanner-container">
	<div id="scanner-item-name"></div>
	<div id="scanner-item-price"></div>
	<select id="scanner-item-select"></select>
	<div id="scanner-barcode-value"></div>
	<input id="scanner-input" type="text">
</div>

<div class="row" id="sortiment-row">
	<div class="col-sm-6">
		<h2>
			Sortiment 
			{% if items %}
			<div id="sortiment-count"> 
				   ({{ items | length }})				    
			</div>
			{% endif %}
		</h2>
	</div>

	{% if items %}			   				    
	<div class="col-sm-6" id="sortiment-search">	
		<input type="text" id="itemsSearchInput" placeholder="Søg" autofocus>
	</div>
	{% endif %}
</div>


{% if items %}
<table class="table table-striped tablesorter" id="items">
	<thead>
		<tr>
			<th>Bryghus</th>
			<th>Navn</th>
			<th class="hidden-xs">Beholder</th>
			<th class="hidden-xs">Type</th>
			<th>Pris</th>
			{% if user.is_staff %}
				<th class="hidden-xs"></th>
			{% endif %}
		</tr>
		</thead>
	<tbody>
	{% for item in items %}
		<tr>
			<td>{{ item.brewery|default_if_none:"" }}</td>
			<td>{{ item.name }}</td>
			<td class="hidden-xs">{{ item.get_container_display }}</td>
			<td class="hidden-xs">{{ item.type|default_if_none:"" }}</td>
			<td>{{ item.priceInDKK|floatformat:-2 }}</td>
			{% if user.is_staff %}
				<td class="hidden-xs"><a href="/admin/items/item/{{ item.id }}">Edit</a></td>
			{% endif %}
		</tr>
	{% endfor %}
	</tbody>
</table>

<script src="{% static 'js/sortimentSearch.js' %}"></script>

{% else %}

	<span>Sortimentet er desværre tomt &#9785;</span>

{% endif %}

{{ items_data|json_script:"items_data" }}
{% csrf_token %}

<script>
var items_data = JSON.parse(document.getElementById('items_data').textContent);
var csrftoken = $('[name=csrfmiddlewaretoken]').val();
function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

{% if user.is_staff %}
var is_admin = true;
{% else %}
var is_admin = false;
{% endif %}

function item_display(item) {
	var s = item.name;
	if (item.brewery) {
		s = item.brewery + ' ' + s;
	}
	return s;
}

function sort_by_key(arr, key) {
	arr.sort(function(a, b) {
		var ka = key(a);
		var kb = key(b);

		if (ka === kb) return 0;
		if (ka < kb) return -1;
		return 1;
	});
}

sort_by_key(items_data, item_display);

var barcode_to_item = {};
for (var i = 0; i < items_data.length; i++) {
	var item = items_data[i];
	if (item.barcode) {
		barcode_to_item[item.barcode] = item;
	}
}

var scanner_container = $('#scanner-container');
var scanner_button = $('#scanner-button');
var scanner_input = $('#scanner-input');
var scanner_barcode_value = $('#scanner-barcode-value');
var scanner_input = $('#scanner-input');
var scanner_item_name = $('#scanner-item-name');
var scanner_item_price = $('#scanner-item-price');
var scanner_item_select = $('#scanner-item-select');

scanner_item_select.append($('<option>').val(-1).text('-----'));
for (var i = 0; i < items_data.length; i++) {
	var item = items_data[i];
	scanner_item_select.append($('<option>').val(i).text(item_display(item)));
}
scanner_item_select.select2();

scanner_button.click(function() {
	scanner_container.attr({'class': 'not-hidden'});
	scanner_input.focus();
});
$(document).keyup(function (e) {
	// Escape key
	if (e.keyCode === 27) {
		scanner_container.attr({'class': ''});
	}
});

function toggle_dropdown(show) {
	scanner_item_select.next('.select2-container').toggle(show);
}
toggle_dropdown(false);

var current_barcode = null;
function set_scanned(item) {
	scanner_barcode_value.text(current_barcode);
	scanner_item_name.text(item_display(item));
	scanner_item_price.text(item.price.replace('.', ',') + ' kr.');
}

scanner_input.keyup(function(e) {
	if (e.keyCode === 13) {
		var barcode = scanner_input.val();
		if (barcode === '') return;
		current_barcode = barcode;

		scanner_input.val('');
		scanner_barcode_value.text(current_barcode);

		var item = barcode_to_item[current_barcode];
		if (item) {
			set_scanned(item);
			toggle_dropdown(false);
		} else {
			scanner_item_name.text('Ikke fundet');

			if (is_admin) {
				scanner_item_price.text('Vælg ting:');
				scanner_item_select.val(-1);
				scanner_item_select.trigger('change');
				toggle_dropdown(true);
				scanner_item_select.select2('open');
			} else {
				scanner_item_price.text('');
			}
		}
	}
});

scanner_item_select.change(function() {
	var index = parseInt(scanner_item_select.val());
	if (index === -1) return;

	var item = items_data[index];

	item.barcode = current_barcode;
	barcode_to_item[current_barcode] = item;

	$.post('/api/update_barcode/', {
		'id': item.id,
		'barcode': current_barcode,
	}, function() {
		set_scanned(item);
	});

	toggle_dropdown(false);

	scanner_input.focus();
});
</script>

{% endblock %}
