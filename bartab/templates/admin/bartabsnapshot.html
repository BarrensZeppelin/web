{% extends 'admin/change_form.html' %}

{% block extrahead %}
    {{ block.super }}

    <script type="text/javascript">
        (function ($) {
            $(function () {
                // Open dropdown on tab
                $(document).on('focus', '.select2.select2-container', function (e) {
                    // only open on original attempt - close focus event should not fire open
                    if (e.originalEvent && $(this).find(".select2-selection--single").length > 0) {
                        $(this).siblings('select').select2('open');
                    }
                });

                var lastEl = null;

                // Automatically select highlighted
                $(document).on('select2:closing', 'select', function (e) {
                    var el = $('.select2-results__option--highlighted').get(0);
                    console.log(el);
                    if (el && el !== lastEl) {
                        lastEl = el;
                        var evt = $.Event('keydown');
                        evt.which = 13;
                        $('.select2-search__field').trigger(evt);
                    }
                });

                function setUntabbables() {
                    $('.related-widget-wrapper-link, .delete > input, .inline-deletelink').attr({tabindex: -1});
                    $('select[tabindex="-1"]').attr({tabindex: 0});  // Fixes incorrectly untabbable selects
                }

                setUntabbables();

                var add_button;

                $(document).on('click', '.add-row a', function (e) {
                    setTimeout(function() {
                        setUntabbables();
                    });
                });

                // Automatically add new inlines
                $(document).on('focus', '.field-raw_added > input', function (e) {
                    var last_fields = $('.field-raw_added > input');
                    if (e.target === last_fields.get(-2)) {
                        if(!add_button) add_button = $('.add-row a');
                        add_button.get(0).click();
                    }
                });
            });
        })(django.jQuery);
    </script>
{% endblock %}
